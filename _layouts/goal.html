{% include head.html %}
{% include header.html %}

<div class="container">
    {% include components/goal/breadcrumbs.html %}
    {% if site.create_goals.previous_next_links %}
    {% include components/previous-next-links.html previous_label=page.t.goal.previous next_label=page.t.goal.next %}
    {% endif %}
</div>

{% include components/goal/header.html %}

{% assign goal_indicators = page.indicators | where: 'goal_number', page.goal.number %}
{% assign show_progress = false %}
{% for indicator in goal_indicators %}
{% if indicator.progress_status and indicator.progress_status != '' %}
{% assign show_progress = true %}
{% endif %}
{% endfor %}

<div id="main-content" class="container" role="main">

    {% include components/goal/goal-content.html content=content %}

    <div class="container g-0 {% if show_progress %}goal-showing-progress{% endif %}">

        <div class="row align-items-end">
            <div class="col">
                <h2 class="goal-page-heading">{{ page.t.general.targets_and_indicators }}</h2>
            </div>
            {% if show_progress %}
            <div class="col-lg-2 d-none d-lg-block progress-column-header">
                <span aria-hidden="true">{{ site.progress_status.status_help | t | default: page.t.status.progress_help }}</span>
            </div>
            {% endif %}
        </div>
        <hr class="goal-page-column-header-rule">

        <p>Всего найдено индикаторов: {{ goal_indicators.size }}</p>
        <div class="alert alert-warning" style="font-family: monospace; font-size: 11px; line-height: 1.2;">
            <strong>DEEP DEBUG:</strong><br>
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Technical Name (ID)</th>
                    <th>Indicator Number</th>
                    <th>Editions Raw</th>
                    <th>Target Number</th>
                </tr>
                </thead>
                <tbody>
                {% for ind in goal_indicators %}
                <tr>
                    <td>{{ ind.indicator_id | default: "N/A" }}</td>
                    <td>{{ ind.number }}</td>
                    <td>{{ ind.editions | inspect }}</td>
                    <td>{{ ind.target_number }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="background: #fff3cd; padding: 20px; font-family: monospace; font-size: 12px;">
            <h6>DEEP DEBUG V2:</h6>
            <table style="width:100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #000;">
                    <th>File ID (slug)</th>
                    <th>Ind. Number</th>
                    <th>Target Number</th>
                    <th>Goal Number</th>
                </tr>
                {% for ind in page.indicators %}
                <tr>
                    <td>{{ ind.indicator_id | default: "N/A" }}</td>
                    <td>{{ ind.indicator_number }}</td>
                    <td>{{ ind.target_number }}</td>
                    <td>{{ ind.goal_number }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <ul class="nav nav-tabs edition-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#current-edition" aria-controls="current-edition" role="tab" data-bs-toggle="tab">
                    <div class="tab-content-wrapper">
                        <span class="radio-dot"></span>
                        <div class="text-group">
                            <span class="tab-title">Редакція розпорядження Кабінету Міністрів України від 29.11.2024 № 1190-р</span>
                            <span class="badge-edition badge-current">ЧИННА</span>
                        </div>
                    </div>
                </a>
            </li>
            <li role="presentation">
                <a href="#archive-edition" aria-controls="archive-edition" role="tab" data-bs-toggle="tab">
                    <div class="tab-content-wrapper">
                        <span class="radio-dot"></span>
                        <div class="text-group">
                            <span class="tab-title">Редакція розпорядження Кабінету Міністрів України від 21.08.2019 № 686-р</span>
                            <span class="badge-edition badge-archive">ПОПЕРЕДНЯ</span>
                        </div>
                    </div>
                </a>
            </li>
        </ul>

        <div class="tab-content">
            {% assign all_indicators = page.indicators | where: "goal_number", page.goal.number %}

            <div role="tabpanel" class="tab-pane edition-tab-pane active" id="current-edition">
                {% assign current_list = "" | split: "" %}
                {% for ind in all_indicators %}
                {% unless ind.indicator_id contains "-a" or ind.indicator_id contains ".a" %}
                {% assign current_list = current_list | push: ind %}
                {% endunless %}
                {% endfor %}

                {% assign grouped_current = current_list | group_by: 'target_number' %}
                {% for group in grouped_current %}
                <div class="target">
                    {% assign target_key = group.name | replace: ".", "-" | append: "-title" %}
                    <h3>{{ group.name }} {{ site.translations.uk.global_targets[target_key] }}</h3>

                    {% for ind in group.items %}
                    {% include components/goal/indicator-item.html indicator=ind %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            <div class="tab-content">
                {% comment %} DEEP DEBUG V3 {% endcomment %}
                <div style="background: #fff3cd; padding: 10px; font-family: monospace; font-size: 11px; margin-bottom: 20px;">
                    DEBUG: Всего в page.indicators: {{ page.indicators.size }} <br>
                    {% for ind in page.indicators %}
                    ID: {{ ind.indicator_id }} | Target: {{ ind.target_number }} <br>
                    {% endfor %}
                </div>

                {% assign all_indicators = page.indicators | where: "goal_number", page.goal.number %}

                <div role="tabpanel" class="tab-pane edition-tab-pane active" id="current-edition">
                    {% assign current_list = "" | split: "" %}
                    {% for ind in all_indicators %}
                    {% comment %} Если в ID нет буквы 'a' — это текущий {% endcomment %}
                    {% unless ind.indicator_id contains "-a" or ind.indicator_id contains ".a" %}
                    {% assign current_list = current_list | push: ind %}
                    {% endunless %}
                    {% endfor %}

                    {% if current_list.size > 0 %}
                    {% assign grouped_current = current_list | group_by: 'target_number' %}
                    {% include components/goal/targets-list.html target_groups=grouped_current show_progress=show_progress %}
                    {% endif %}
                </div>

                <div role="tabpanel" class="tab-pane edition-tab-pane" id="archive-edition">
                    {% assign archive_list = "" | split: "" %}
                    {% for ind in all_indicators %}
                    {% comment %} Если в ID есть буква 'a' — это архив {% endcomment %}
                    {% if ind.indicator_id contains "-a" or ind.indicator_id contains ".a" %}
                    {% assign archive_list = archive_list | push: ind %}
                    {% endif %}
                    {% endfor %}

                    {% if archive_list.size > 0 %}
                    {% assign grouped_archive = archive_list | group_by: 'target_number' %}
                    {% include components/goal/targets-list.html target_groups=grouped_archive show_progress=show_progress %}
                    {% else %}
                    <p style="padding: 20px;">В цій цілі немає показників попередньої редакції.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
    {% include back-to-top.html %}
</div>

{% include footer.html %}
